{% extends "base.html" %}
{% block title %}Admin Dashboard {% endblock %}

{% block content %}
<!-- Loading screen -->
<!-- <div id="loading-screen" role="alert" aria-live="assertive" aria-label="Loading dashboard"
    style="position: fixed; inset: 0; background: #1e1e1e; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #eee; font-size: 1.2rem; z-index: 9999;">
    <div class="loader" aria-hidden="true"
        style="border: 5px solid #333; border-top: 5px solid #0078d7; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 1rem;">
    </div>
    <p style="font-weight: 600; margin:0;">Loading - Please wait...</p>
</div> -->

<header role="banner"
    style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; background-color: #0078d7; color: white; box-shadow: 0 2px 8px rgb(0 0 0 / 0.3); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <div style="display: flex; flex-direction: column; gap: 0.1rem;">
        <h2 style="margin: 0; font-weight: 700; font-size: 1.4rem; user-select:none;">Maahad Istiqama — Admin</h2>
        <div style="font-size: 0.9rem; opacity: 0.8; user-select:none;">Analytics • Live</div>
    </div>

    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div aria-live="polite" aria-atomic="true" role="timer" aria-label="Current date and time"
            style="font-weight: 600; font-size: 0.95rem; min-width: 180px; text-align: center; user-select: none;">
            <!-- JS fills current datetime -->
        </div>

        <div role="region" aria-label="Global filters" style="display: flex; align-items: center; gap: 0.5rem;">
            <label class="visually-hidden" for="filterTerm">Term</label>
            <select id="filterTerm" aria-label="Select term"
                style="padding: 0.3rem 0.5rem; border-radius: 4px; border: none; font-size: 0.95rem; cursor:pointer;">
                <option value="all">All terms</option>
                <option value="term1">Term 1</option>
                <option value="term2">Term 2</option>
            </select>

            <label class="visually-hidden" for="filterClass">Class</label>
            <select id="filterClass" aria-label="Select class"
                style="padding: 0.3rem 0.5rem; border-radius: 4px; border: none; font-size: 0.95rem; cursor:pointer;">
                <option value="all">All classes</option>
                {% for c in classes %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
            </select>

            <button id="refreshData" title="Refresh data"
                style="background: #005a9e; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0.15rem 0.5rem; user-select: none;">⟳</button>
        </div>

        <div style="display: flex; align-items: center; gap: 0.7rem;">
            <button id="darkModeToggle" aria-pressed="false" aria-label="Toggle dark mode" title="Toggle Dark Mode"
                style="background: transparent; border: 1.8px solid white; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; color: white; font-weight: 600; font-size: 0.9rem;">
                <i class="fa-solid fa-moon" aria-hidden="true"></i>
                <span class="btn-text">Dark</span>
            </button>
            <button id="exportCsv" title="Export summary to CSV"
                style="background: #005a9e; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9rem; padding: 0.35rem 0.8rem; font-weight: 600;">Export
                CSV</button>
        </div>
    </div>
</header>

<main tabindex="0" aria-label="Admin Dashboard main content"
    style="display: flex; height: calc(100vh - 68px); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; color: #333; overflow: hidden;">

    <!-- <nav aria-label="Left navigation"
        style="width: 220px; background-color: #0f4c81; color: white; padding-top: 1rem; display: flex; flex-direction: column; box-shadow: inset -1px 0 6px rgb(0 0 0 / 0.3); user-select:none;">
        <ul style="list-style: none; padding-left: 0; margin: 0; display: flex; flex-direction: column; gap: 0.2rem;">
            <li tabindex="0" aria-current="page"
                style="padding: 0.9rem 1.4rem; font-weight: 600; background-color: #0078d7; cursor: pointer; outline-offset: -2px;">
                Overview</li>
            <li tabindex="0"
                style="padding: 0.9rem 1.4rem; font-weight: 600; cursor: pointer; opacity: 0.9; outline-offset: -2px;">
                Teachers</li>
            <li tabindex="0"
                style="padding: 0.9rem 1.4rem; font-weight: 600; cursor: pointer; opacity: 0.9; outline-offset: -2px;">
                Students</li>
            <li tabindex="0"
                style="padding: 0.9rem 1.4rem; font-weight: 600; cursor: pointer; opacity: 0.9; outline-offset: -2px;">
                Timetable</li>
            <li tabindex="0"
                style="padding: 0.9rem 1.4rem; font-weight: 600; cursor: pointer; opacity: 0.9; outline-offset: -2px;">
                Reports</li>
        </ul>
    </nav> -->

    <section style="flex-grow: 1; display: flex; flex-direction: column; padding: 1rem 1.5rem; overflow-y: auto;">

        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
            <h1 style="font-weight: 700; font-size: 1.9rem; color: #0f4c81; margin: 0; user-select:none;">Admin
                Dashboard</h1>

            <div style="flex-grow: 1; max-width: 320px;">
                <input type="search" id="cardSearch" placeholder="Search cards, classes, subjects..."
                    aria-label="Search dashboard stats"
                    style="width: 100%; padding: 0.4rem 0.8rem; border-radius: 6px; border: 1.8px solid #ccc; font-size: 1rem; transition: border-color 0.3s ease; outline-offset: 2px;">
            </div>
        </div>

        <!-- KPI Row -->
        <div role="list" aria-live="polite" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            {% set kpi_bg = '#0078d7' %}
            {% set kpi_color = 'white' %}
            <div role="listitem" tabindex="0" aria-describedby="desc-teachers" data-key="teachers"
                style="flex: 1 1 180px; background: {{ kpi_bg }}; color: {{ kpi_color }}; padding: 1.2rem 1rem; border-radius: 10px; box-shadow: 0 4px 10px rgb(0 120 215 / 0.3); display: flex; align-items: center; gap: 1rem; cursor: default; user-select: none; outline-offset: 2px;">
                <div style="font-size: 2.6rem; opacity: 0.85;"><i class="fa-solid fa-person-chalkboard"
                        aria-hidden="true"></i></div>
                <div style="flex-grow: 1;">
                    <div id="desc-teachers" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.15rem;">Total
                        Teachers</div>
                    <div style="font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 0.1rem;">{{
                        total_teachers }}</div>
                    <div style="opacity: 0.85; font-weight: 600;">Registered</div>
                </div>
            </div>

            <div role="listitem" tabindex="0" aria-describedby="desc-subjects" data-key="subjects"
                style="flex: 1 1 180px; background: #005a9e; color: white; padding: 1.2rem 1rem; border-radius: 10px; box-shadow: 0 4px 10px rgb(0 90 158 / 0.3); display: flex; align-items: center; gap: 1rem; cursor: default; user-select: none; outline-offset: 2px;">
                <div style="font-size: 2.6rem; opacity: 0.85;"><i class="fa-solid fa-book" aria-hidden="true"></i></div>
                <div style="flex-grow: 1;">
                    <div id="desc-subjects" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.15rem;">Total
                        Subjects</div>
                    <div style="font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 0.1rem;">{{
                        total_subjects }}</div>
                    <div style="opacity: 0.85; font-weight: 600;">Offered</div>
                </div>
            </div>

            <div role="listitem" tabindex="0" aria-describedby="desc-classes" data-key="classes"
                style="flex: 1 1 180px; background: #004273; color: white; padding: 1.2rem 1rem; border-radius: 10px; box-shadow: 0 4px 10px rgb(0 66 115 / 0.3); display: flex; align-items: center; gap: 1rem; cursor: default; user-select: none; outline-offset: 2px;">
                <div style="font-size: 2.6rem; opacity: 0.85;"><i class="fa-solid fa-school" aria-hidden="true"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div id="desc-classes" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.15rem;">Total
                        Classes</div>
                    <div style="font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 0.1rem;">{{
                        total_classes }}</div>
                    <div style="opacity: 0.85; font-weight: 600;">Active</div>
                </div>
            </div>

            <div role="listitem" tabindex="0" aria-describedby="desc-periods" data-key="periods"
                style="flex: 1 1 180px; background: #00325a; color: white; padding: 1.2rem 1rem; border-radius: 10px; box-shadow: 0 4px 10px rgb(0 50 90 / 0.3); display: flex; align-items: center; gap: 1rem; cursor: default; user-select: none; outline-offset: 2px;">
                <div style="font-size: 2.6rem; opacity: 0.85;"><i class="fa-solid fa-clock-rotate-left"
                        aria-hidden="true"></i></div>
                <div style="flex-grow: 1;">
                    <div id="desc-periods" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.15rem;">Total
                        Periods</div>
                    <div style="font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 0.1rem;">{{
                        total_periods }}</div>
                    <div style="opacity: 0.85; font-weight: 600;">Scheduled</div>
                </div>
            </div>
        </div>

        <!-- Charts grid -->
        <section aria-label="Dashboard charts"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); grid-gap: 1rem; margin-bottom: 1.5rem;">

            <div role="region" aria-labelledby="weeklyLoadLabel" data-panel="weekly"
                style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; padding: 1rem;">
                <header
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                    <h3 id="weeklyLoadLabel" style="margin: 0; font-weight: 700; font-size: 1.2rem; color: #0f4c81;">
                        Weekly Allocation Load</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="downloadChart('weeklyLoadChart','weekly-load.png')"
                            style="background: #0078d7; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Export</button>
                        <button onclick="pinPanel(this)"
                            style="background: #0f4c81; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Pin</button>
                    </div>
                </header>
                <div style="position: relative;">
                    <canvas id="weeklyLoadChart" role="img" aria-describedby="weeklyLoadDesc"
                        style="max-width: 100%; height: 260px;"></canvas>
                    <p id="weeklyLoadDesc" class="sr-only">Line chart showing allocation load per week</p>
                    <div id="weekly-legend" aria-hidden="true"
                        style="margin-top: 0.5rem; font-size: 0.9rem; color: #444;"></div>
                </div>
            </div>

            <div role="region" aria-labelledby="subjectsPerClassLabel" data-panel="subjects"
                style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; padding: 1rem;">
                <header
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                    <h3 id="subjectsPerClassLabel"
                        style="margin: 0; font-weight: 700; font-size: 1.2rem; color: #0f4c81;">Subjects Per Class</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="toggleCollapse(this)"
                            style="background: #0078d7; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Collapse</button>
                        <button onclick="downloadChart('subjectsPerClassChart','subjects-per-class.png')"
                            style="background: #0f4c81; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Export</button>
                    </div>
                </header>
                <div style="position: relative;">
                    <canvas id="subjectsPerClassChart" role="img" aria-describedby="subjectsPerClassDesc"
                        style="max-width: 100%; height: 260px;"></canvas>
                    <p id="subjectsPerClassDesc" class="sr-only">Bar chart showing subjects distribution across classes
                    </p>
                </div>
            </div>

            <div role="region" aria-labelledby="teacherSubjectLabel" data-panel="teachers" style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
            <div role=" region" aria-labelledby="teacherSubjectLabel" data-panel="teachers"
                style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; padding: 1rem;">
                <header
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                    <h3 id="teacherSubjectLabel"
                        style="margin: 0; font-weight: 700; font-size: 1.2rem; color: #0f4c81;">Teacher Subjects
                        Distribution</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="downloadChart('teacherSubjectChart','teacher-subjects.png')"
                            style="background: #0078d7; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Export</button>
                        <button onclick="pinPanel(this)"
                            style="background: #0f4c81; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Pin</button>
                    </div>
                </header>
                <div style="position: relative;">
                    <canvas id="teacherSubjectChart" role="img" aria-describedby="teacherSubjectDesc"
                        style="max-width: 100%; height: 260px;"></canvas>
                    <p id="teacherSubjectDesc" class="sr-only">Pie chart showing subject distribution among teachers</p>
                </div>
            </div>

            <div role="region" aria-labelledby="classSubjectLabel" data-panel="classes"
                style="background: white; border-radius: 8px; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; padding: 1rem;">
                <header
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem;">
                    <h3 id="classSubjectLabel" style="margin: 0; font-weight: 700; font-size: 1.2rem; color: #0f4c81;">
                        Classes vs Subjects Chart</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="downloadChart('classSubjectChart','classes-vs-subjects.png')"
                            style="background: #0078d7; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Export</button>
                        <button onclick="pinPanel(this)"
                            style="background: #0f4c81; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">Pin</button>
                    </div>
                </header>
                <div style="position: relative;">
                    <canvas id="classSubjectChart" role="img" aria-describedby="classSubjectDesc"
                        style="max-width: 100%; height: 260px;"></canvas>
                    <p id="classSubjectDesc" class="sr-only">Stacked bar chart showing subjects assigned to each class
                    </p>
                </div>
            </div>
        </section>

    </section>
</main>

<!-- Inline style for spin animation and visually hidden classes -->
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .visually-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Live time update in header (with accessible timer role)
    const timeContainer = document.querySelector('header [role="timer"]');
    function updateTime() {
        if (!timeContainer) return;
        const now = new Date();
        timeContainer.textContent = now.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
    }
    setInterval(updateTime, 1000);
    updateTime();

    // === Dummy data (replace with dynamic data from backend) ===
    const weeklyDays = ["Mon", "Tue", "Wed", "Thu", "Fri"];
    const weeklyLoad = [5, 7, 6, 8, 7]; // e.g., total hours per day

    const classes = ["Class 1", "Class 2", "Class 3", "Class 4"];
    const subjectsCount = [12, 9, 7, 10];  // number of subjects per class

    const teacherSubjectsData = {
        labels: ["Math", "English", "Science", "History", "Art"],
        data: [10, 8, 5, 7, 4] // teachers teaching each subject
    };

    const classesVsSubjectsData = {
        classes: ["Class 1", "Class 2", "Class 3", "Class 4"],
        subjects: ["Math", "English", "Science"],
        data: [
            [3, 2, 1],  // Class 1 subject counts
            [2, 3, 2],  // Class 2
            [1, 2, 3],  // Class 3
            [4, 1, 2]   // Class 4
        ]
    };

    // Chart instances
    let weeklyLoadChart, subjectsCountChart, teacherSubjectChart, classSubjectChart;

    // Create Weekly Load Line Chart
    function createWeeklyLoadChart() {
        const ctx = document.getElementById('weeklyLoadChart').getContext('2d');
        if (weeklyLoadChart) weeklyLoadChart.destroy();
        weeklyLoadChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeklyDays,
                datasets: [{
                    label: 'Weekly Load (hours)',
                    data: weeklyLoad,
                    fill: false,
                    borderColor: '#0f4c81',
                    backgroundColor: '#0f4c81',
                    tension: 0.3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Hours' }
                    }
                }
            }
        });
    }

    // Create Subjects Count Bar Chart
    function createSubjectsCountChart() {
        const ctx = document.getElementById('subjectsCountChart').getContext('2d');
        if (subjectsCountChart) subjectsCountChart.destroy();
        subjectsCountChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: classes,
                datasets: [{
                    label: 'Number of Subjects',
                    data: subjectsCount,
                    backgroundColor: '#0078d7'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stepSize: 1,
                        title: { display: true, text: 'Subjects Count' }
                    }
                }
            }
        });
    }

    // Create Teacher Subjects Pie Chart
    function createTeacherSubjectChart() {
        const ctx = document.getElementById('teacherSubjectChart').getContext('2d');
        if (teacherSubjectChart) teacherSubjectChart.destroy();
        teacherSubjectChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: teacherSubjectsData.labels,
                datasets: [{
                    label: 'Teacher Subjects Distribution',
                    data: teacherSubjectsData.data,
                    backgroundColor: [
                        '#0f4c81',
                        '#0078d7',
                        '#00a1ff',
                        '#66b2ff',
                        '#99ccff'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { enabled: true }
                }
            }
        });
    }

    // Create Class vs Subject Stacked Bar Chart
    function createClassSubjectChart() {
        const ctx = document.getElementById('classSubjectChart').getContext('2d');
        if (classSubjectChart) classSubjectChart.destroy();

        // Prepare datasets for each subject
        const datasets = classesVsSubjectsData.subjects.map((subject, idx) => {
            return {
                label: subject,
                data: classesVsSubjectsData.data.map(row => row[idx]),
                backgroundColor: getColorByIndex(idx),
            };
        });

        function getColorByIndex(i) {
            const colors = ['#0f4c81', '#0078d7', '#00a1ff', '#66b2ff', '#99ccff', '#cce5ff'];
            return colors[i % colors.length];
        }

        classSubjectChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: classesVsSubjectsData.classes,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Subjects Count' } }
                }
            }
        });
    }

    // Initialize all charts on window load
    window.addEventListener('load', () => {
        createWeeklyLoadChart();
        createSubjectsCountChart();
        createTeacherSubjectChart();
        createClassSubjectChart();
    });

    // Button Handlers (add your actual backend logic as needed)

    document.getElementById('refreshData')?.addEventListener('click', () => {
        alert('Refresh data clicked - implement backend AJAX call here to update charts.');
        // Example: fetch('/api/dashboard-data').then(...).then(update charts)
    });

    document.getElementById('darkModeToggle')?.addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', !pressed);
        document.body.classList.toggle('dark-mode', !pressed);
    });

    document.getElementById('exportCsv')?.addEventListener('click', () => {
        alert('Export CSV clicked - implement CSV export logic here!');
        // Example: generate CSV string and trigger download
    });

    // Download chart as PNG image
    function downloadChart(chartId, filename) {
        const canvas = document.getElementById(chartId);
        if (!canvas) return;
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // Pin or unpin a dashboard panel visually
    function pinPanel(button) {
        const panel = button.closest('[data-panel]');
        if (!panel) return;
        if (panel.style.border) {
            panel.style.border = '';
            button.textContent = 'Pin';
        } else {
            panel.style.border = '3px solid #0078d7';
            button.textContent = 'Unpin';
        }
    }

    // Collapse or expand chart canvas in a panel
    function toggleCollapse(button) {
        const panel = button.closest('[data-panel]');
        if (!panel) return;
        const canvas = panel.querySelector('canvas');
        if (!canvas) return;
        if (canvas.style.display === 'none' || canvas.style.display === '') {
            canvas.style.display = 'block';
            button.textContent = 'Collapse';
        } else {
            canvas.style.display = 'none';
            button.textContent = 'Expand';
        }
    }

    // Expose functions globally for button onclick handlers
    window.downloadChart = downloadChart;
    window.pinPanel = pinPanel;
    window.toggleCollapse = toggleCollapse;
</script>



{% endblock %}